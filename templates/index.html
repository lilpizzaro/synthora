<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="theme-color" content="#007AFF" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Ducky AI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Auth Overlay -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-container">
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
                <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
            </div>
            
            <!-- Login Form -->
            <form id="loginForm" class="auth-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <input type="text" id="loginUsername" placeholder="Username" required>
                </div>
                <div class="form-group">
                    <input type="password" id="loginPassword" placeholder="Password" required>
                </div>
                <button type="submit" class="auth-button">Login</button>
            </form>
            
            <!-- Signup Form -->
            <form id="signupForm" class="auth-form" style="display: none;" onsubmit="handleSignup(event)">
                <div class="form-group">
                    <input type="text" id="signupUsername" placeholder="Choose Username" required>
                </div>
                <div class="form-group">
                    <input type="password" id="signupPassword" placeholder="Choose Password" required>
                </div>
                <div class="form-group">
                    <input type="password" id="confirmPassword" placeholder="Confirm Password" required>
                </div>
                <button type="submit" class="auth-button">Sign Up</button>
            </form>
            
            <div id="authError" class="auth-error"></div>
        </div>
    </div>

    <!-- Splash Screen -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-content">
            <div class="hello-animation">
                <span class="hello-text">Hello</span>
                <span class="hello-cursor"></span>
            </div>
            <div class="splash-logo">
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Ducky AI Logo" class="splash-icon">
                <span class="splash-title">ducky</span>
            </div>
            <div class="splash-credits">
                <span>Created by</span>
                <span class="credit-name">Amaan Dildar</span>
            </div>
        </div>
    </div>

    <!-- Main App Content -->
    <div class="container" style="display: none;" id="mainContent">
        <!-- Slide-out Menu -->
        <div class="slide-menu-overlay" id="menuOverlay"></div>
        <div class="slide-menu" id="slideMenu">
            <button class="menu-item" onclick="showAccount()">
                <span>üë§</span>
                Account
            </button>
            <button class="menu-item" onclick="showMemories()">
                <span>üí≠</span>
                Memories
            </button>
            <button class="menu-item" onclick="toggleDarkMode()">
                <span>üåì</span>
                Theme
            </button>
            <button class="menu-item" onclick="clearChat()">
                <span>üóëÔ∏è</span>
                Clear Chat
            </button>
            <button class="menu-item" onclick="shareChat()">
                <span>üì§</span>
                Share
            </button>
            <button class="menu-item" onclick="toggleSound()">
                <span>üîä</span>
                Sound
            </button>
            <button class="menu-item" onclick="toggleNotifications()">
                <span>üîî</span>
                Notifications
            </button>
            <button class="menu-item" onclick="logout()">
                <span>üö™</span>
                Logout
            </button>
        </div>

        <div class="chat-header">
            <button class="menu-button" id="menuButton">‚ò∞</button>
            <h1>
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Ducky AI Logo" class="icon">
                <span class="title">Ducky AI</span>
            </h1>
            <div style="width: 40px"></div><!-- Spacer for alignment -->
        </div>
        <div class="chat-container" id="chatContainer">
            <div class="message ducky-message">
                <div class="avatar">
                    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Ducky AI Logo" class="avatar-img">
                </div>
                <div class="text">
                    <div class="typing-animation">
                        <span>Quack! Hello there!</span>
                        <span>I'm your friendly AI duck assistant.</span>
                        <span>How can I help you today? ü¶Ü</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="input-container">
            <div class="input-wrapper">
                <input type="text" id="userInput" placeholder="Message Ducky..." autocomplete="off">
            </div>
            <button id="sendButton" onclick="sendMessage()">
                <span class="button-text">Send</span>
            </button>
        </div>
    </div>

    <!-- Add Memories Modal -->
    <div class="memories-modal" id="memoriesModal">
        <div class="memories-content">
            <div class="memories-header">
                <h2>Your Memories</h2>
                <button class="close-button" onclick="hideMemories()">‚úï</button>
            </div>
            <div class="memories-list" id="memoriesList"></div>
        </div>
    </div>

    <!-- Account Modal -->
    <div class="account-modal" id="accountModal">
        <div class="account-content">
            <div class="account-header">
                <h2>Account Settings</h2>
                <button class="close-button" onclick="hideAccount()">‚úï</button>
            </div>
            <div class="account-body">
                <div class="avatar-section">
                    <div class="avatar-preview" onclick="document.getElementById('avatarUpload').click()">
                        <img id="avatarImage" src="{{ url_for('static', filename='images/default-avatar.png') }}" alt="Profile Picture">
                    </div>
                    <input type="file" id="avatarUpload" class="avatar-upload" accept="image/*" onchange="handleAvatarChange(event)">
                    <button class="avatar-button" onclick="document.getElementById('avatarUpload').click()">
                        Change Picture
                    </button>
                </div>
                <form class="account-form" onsubmit="updateAccount(event)">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="accountUsername" placeholder="Enter username" required>
                    </div>
                    <div class="form-group">
                        <label for="currentPassword">Current Password</label>
                        <input type="password" id="currentPassword" placeholder="Enter current password">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">New Password</label>
                        <input type="password" id="newPassword" placeholder="Enter new password">
                    </div>
                    <div class="form-group">
                        <label for="confirmNewPassword">Confirm New Password</label>
                        <input type="password" id="confirmNewPassword" placeholder="Confirm new password">
                    </div>
                    <div class="account-actions">
                        <button type="button" class="cancel-button" onclick="hideAccount()">Cancel</button>
                        <button type="submit" class="save-button">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let conversationId = null;
        let pingInterval = null;
        let pingFailCount = 0;
        const MAX_PING_FAILURES = 3;
        const PING_INTERVAL = 120000; // 2 minutes in milliseconds
        let currentUser = null;
        
        // Add ping functionality
        function startPingInterval() {
            // Clear any existing interval
            if (pingInterval) {
                clearInterval(pingInterval);
            }
            
            // Reset failure count
            pingFailCount = 0;
            
            // Start new ping interval
            pingInterval = setInterval(async () => {
                try {
                    const response = await fetch('/ping');
                    if (!response.ok) {
                        throw new Error('Ping failed');
                    }
                    // Reset failure count on successful ping
                    pingFailCount = 0;
                } catch (error) {
                    console.error('Ping error:', error);
                    pingFailCount++;
                    
                    if (pingFailCount >= MAX_PING_FAILURES) {
                        clearInterval(pingInterval);
                        showError('Lost connection to server. Please refresh the page.');
                    }
                }
            }, PING_INTERVAL);
        }

        // Check authentication status on load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
        });

        function checkAuthStatus() {
            fetch('/auth/status')
                .then(response => response.json())
                .then(data => {
                    if (data.authenticated) {
                        currentUser = data.username;
                        hideAuthOverlay();
                        startApp();
                    } else {
                        showAuthOverlay();
                    }
                })
                .catch(error => {
                    console.error('Auth status error:', error);
                    showAuthOverlay();
                });
        }

        function showAuthOverlay() {
            document.getElementById('authOverlay').style.display = 'flex';
            document.getElementById('splashScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
        }

        function hideAuthOverlay() {
            document.getElementById('authOverlay').style.display = 'none';
        }

        function switchAuthTab(tab) {
            document.getElementById('loginForm').style.display = tab === 'login' ? 'flex' : 'none';
            document.getElementById('signupForm').style.display = tab === 'signup' ? 'flex' : 'none';
            
            // Update active tab
            document.querySelectorAll('.auth-tab').forEach(button => {
                button.classList.toggle('active', button.textContent.toLowerCase() === tab);
            });
            
            // Clear error message
            document.getElementById('authError').textContent = '';
        }

        function showError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch('/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentUser = data.username;
                    hideAuthOverlay();
                    startApp();
                } else {
                    showError(data.error || 'Login failed');
                }
            } catch (error) {
                showError('Network error. Please try again.');
            }
        }

        async function handleSignup(event) {
            event.preventDefault();
            const username = document.getElementById('signupUsername').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (password !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }
            
            try {
                const response = await fetch('/auth/signup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentUser = data.username;
                    hideAuthOverlay();
                    startApp();
                } else {
                    showError(data.error || 'Signup failed');
                }
            } catch (error) {
                showError('Network error. Please try again.');
            }
        }

        async function logout() {
            try {
                await fetch('/auth/logout', { method: 'POST' });
                currentUser = null;
                showAuthOverlay();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        function startApp() {
            // Initialize conversation ID
            conversationId = null;
            
            // Start the ping interval
            startPingInterval();
            
            // Show main content and hide auth overlay
            const authOverlay = document.getElementById('authOverlay');
            const mainContent = document.getElementById('mainContent');
            const splashScreen = document.getElementById('splashScreen');
            
            authOverlay.style.display = 'none';
            splashScreen.style.display = 'flex';
            mainContent.style.display = 'none';
            
            // Show splash screen animation
            setTimeout(function() {
                splashScreen.classList.add('fade-out');
                
                setTimeout(function() {
                    splashScreen.style.display = 'none';
                    mainContent.style.display = 'flex';
                    mainContent.classList.add('fade-in');
                    
                    // Clear chat and add welcome message
                    const chatContainer = document.getElementById('chatContainer');
                    chatContainer.innerHTML = '';
                    
                    addMessageToChat('ducky', [
                        `Welcome back, ${currentUser}! üëã`,
                        'I\'m your friendly AI duck assistant.',
                        'How can I help you today? ü¶Ü'
                    ]);
                    
                    // Focus input field
                    document.getElementById('userInput').focus();
                }, 800);
            }, 4500);
        }

        // Add message to chat
        function addMessageToChat(type, message) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            // Remove any existing typing indicators for Ducky messages
            if (type === 'ducky') {
                const typingMessages = document.querySelectorAll('.typing-message');
                typingMessages.forEach(msg => msg.remove());
            }
            
            let content = '';
            
            if (type === 'user') {
                content = `
                    <div class="text">${escapeHtml(message)}</div>
                    <div class="avatar">
                        <span class="user-icon">üë§</span>
                    </div>
                `;
            } else if (type === 'ducky') {
                content = `
                    <div class="avatar">
                        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Ducky AI Logo" class="avatar-img">
                    </div>
                    <div class="text">${escapeHtml(message)}</div>
                `;
            } else if (type === 'error') {
                content = `
                    <div class="avatar">‚ö†Ô∏è</div>
                    <div class="text">${escapeHtml(message)}</div>
                `;
            }
            
            messageDiv.innerHTML = content;
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        // Scroll to bottom of chat
        function scrollToBottom() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Add loading state to button
        function setButtonLoading(loading) {
            const button = document.getElementById('sendButton');
            const buttonText = button.querySelector('.button-text');
            
            if (loading) {
                button.disabled = true;
                buttonText.textContent = '...';
                button.classList.add('loading');
            } else {
                button.disabled = false;
                buttonText.textContent = 'Send';
                button.classList.remove('loading');
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Add typing animation to messages
        function addTypingAnimation(text) {
            // Simpler version that ensures text actually appears
            return escapeHtml(text);
        }

        // Create a typing indicator with animated dots
        function createTypingIndicator() {
            return `
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
        }

        function sendMessage() {
            const inputField = document.getElementById('userInput');
            const message = inputField.value.trim();
            
            if (!message) return;
            
            // Debug log
            console.log('Sending message:', message);
            
            // Add user message to chat
            addMessageToChat('user', message);
            
            // Clear input
            inputField.value = '';
            
            // Add typing indicator
            const chatContainer = document.getElementById('chatContainer');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ducky-message typing-message';
            typingDiv.innerHTML = `
                <div class="avatar">
                    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Ducky AI Logo" class="avatar-img">
                </div>
                <div class="text">${createTypingIndicator()}</div>
            `;
            chatContainer.appendChild(typingDiv);
            scrollToBottom();
            
            // Set button to loading state
            setButtonLoading(true);
            
            // Call the API for a response
            fetch('/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    conversation_id: conversationId
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('API response received:', data);
                
                // Remove typing indicator
                const typingMessages = document.querySelectorAll('.typing-message');
                typingMessages.forEach(msg => msg.remove());
                
                // Add the actual API response
                addMessageToChat('ducky', data.response);
                
                // Store conversation ID if provided
                if (data.conversation_id) {
                    conversationId = data.conversation_id;
                }
                
                // Reset button state
                setButtonLoading(false);
            })
            .catch(error => {
                console.error('API error:', error);
                
                // Remove typing indicator
                const typingMessages = document.querySelectorAll('.typing-message');
                typingMessages.forEach(msg => msg.remove());
                
                // Show error message
                addMessageToChat('error', 'Sorry, I\'m having trouble connecting right now. Please try again later.');
                
                // Reset button state
                setButtonLoading(false);
            });
            
            // Focus input field
            inputField.focus();
        }

        // Add enter key support
        document.getElementById('userInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Focus input on page load
        window.addEventListener('load', function() {
            document.getElementById('userInput').focus();
        });

        // Menu functions
        function clearChat() {
            const chatContainer = document.getElementById('chatContainer');
            // Clear the chat
            chatContainer.innerHTML = '';
            conversationId = null;
            
            // Add initial welcome message from Ducky
            setTimeout(() => {
                addMessageToChat('ducky', [
                    'Quack! Hello there!',
                    'I\'m your friendly AI duck assistant.',
                    'How can I help you today? ü¶Ü'
                ]);
            }, 300);
        }

        function toggleDarkMode() {
            const body = document.body;
            const isDarkMode = body.classList.contains('dark-mode');
            
            if (isDarkMode) {
                body.classList.remove('dark-mode');
                body.classList.remove('force-dark');
                body.classList.add('force-light');
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.add('dark-mode');
                body.classList.add('force-dark');
                body.classList.remove('force-light');
                localStorage.setItem('theme', 'dark');
            }
            
            // Update splash screen colors based on theme
            updateSplashScreenTheme(!isDarkMode);
        }

        // Add helper function for theme icons
        function getThemeIcon(theme) {
            switch (theme) {
                case 'dark': return '‚òÄÔ∏è';
                case 'light': return 'üåë';
                default: return 'üåì';
            }
        }

        async function shareChat() {
            try {
                // Get all message texts
                const messages = Array.from(document.querySelectorAll('.message .text'))
                    .map(el => el.textContent.trim())
                    .join('\n\n');
                
                if (navigator.share) {
                    await navigator.share({
                        title: 'Chat with Ducky AI',
                        text: messages
                    });
                } else {
                    // Fallback for browsers that don't support the Web Share API
                    const textarea = document.createElement('textarea');
                    textarea.value = messages;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    alert('Chat copied to clipboard!');
                }
            } catch (error) {
                console.error('Error sharing:', error);
            }
        }

        // Menu handling
        const menuButton = document.getElementById('menuButton');
        const slideMenu = document.getElementById('slideMenu');
        const menuOverlay = document.getElementById('menuOverlay');

        menuButton.addEventListener('click', toggleMenu);
        menuOverlay.addEventListener('click', toggleMenu);

        function toggleMenu() {
            slideMenu.classList.toggle('active');
            menuOverlay.classList.toggle('active');
            menuButton.textContent = slideMenu.classList.contains('active') ? '‚úï' : '‚ò∞';
        }

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            if (slideMenu.classList.contains('active') &&
                !e.target.closest('.slide-menu') &&
                !e.target.closest('.menu-button')) {
                toggleMenu();
            }
        });

        // New menu functions
        function toggleSound() {
            // Implement sound toggle functionality
            alert('Sound toggle coming soon!');
        }

        function toggleNotifications() {
            // Implement notifications toggle functionality
            alert('Notifications toggle coming soon!');
        }

        // Update theme initialization
        window.addEventListener('load', function() {
            const savedTheme = localStorage.getItem('theme') || 'system';
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const body = document.body;
            
            if (savedTheme === 'dark' || (savedTheme === 'system' && prefersDark)) {
                body.classList.add('force-dark');
                body.classList.add('dark-mode');
                body.classList.remove('force-light');
                updateSplashScreenTheme(true);
            } else if (savedTheme === 'light' || (savedTheme === 'system' && !prefersDark)) {
                body.classList.add('force-light');
                body.classList.remove('force-dark');
                body.classList.remove('dark-mode');
                updateSplashScreenTheme(false);
            }
            
            // Update all theme button icons
            const themeButtons = document.querySelectorAll('[onclick="toggleDarkMode()"]');
            themeButtons.forEach(button => {
                const themeIcon = button.querySelector('span');
                if (themeIcon) {
                    themeIcon.textContent = getThemeIcon(savedTheme);
                }
            });
        });

        // Handle swipe to close menu (update for left side)
        let touchStartX = 0;
        slideMenu.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
        });

        slideMenu.addEventListener('touchmove', (e) => {
            if (!slideMenu.classList.contains('active')) return;
            
            const touchX = e.touches[0].clientX;
            const diff = touchStartX - touchX;
            
            if (diff > 30) {
                toggleMenu();
            }
        });

        // Prevent bounce scrolling on iOS
        document.body.addEventListener('touchmove', (e) => {
            if (e.target.closest('.chat-container')) return;
            e.preventDefault();
        }, { passive: false });

        // Update the message template to use the logo image
        function createMessageElement(text, isDucky = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isDucky ? 'ducky-message' : 'user-message'}`;
            
            // Create avatar
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'avatar';
            
            if (isDucky) {
                const avatarImg = document.createElement('img');
                avatarImg.src = "{{ url_for('static', filename='images/logo.png') }}";
                avatarImg.alt = "Ducky AI Logo";
                avatarImg.className = "avatar-img";
                avatarDiv.appendChild(avatarImg);
            }
            
            // Create text container
            const textDiv = document.createElement('div');
            textDiv.className = 'text';
            
            if (Array.isArray(text)) {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'typing-animation';
                
                text.forEach(line => {
                    const span = document.createElement('span');
                    span.textContent = line;
                    typingDiv.appendChild(span);
                });
                
                textDiv.appendChild(typingDiv);
            } else {
                textDiv.textContent = text;
            }
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(textDiv);
            
            return messageDiv;
        }

        // Function to update splash screen theme
        function updateSplashScreenTheme(isDarkMode) {
            const root = document.documentElement;
            if (isDarkMode) {
                root.style.setProperty('--splash-background', '#1d1d1f');
                root.style.setProperty('--splash-text', '#ffffff');
                root.style.setProperty('--splash-text-rgb', '255, 255, 255');
            } else {
                root.style.setProperty('--splash-background', '#ffffff');
                root.style.setProperty('--splash-text', '#000000');
                root.style.setProperty('--splash-text-rgb', '0, 0, 0');
            }
        }

        async function showMemories() {
            try {
                const response = await fetch('/memories');
                const memories = await response.json();
                
                const memoriesList = document.getElementById('memoriesList');
                memoriesList.innerHTML = '';
                
                if (memories.length === 0) {
                    memoriesList.innerHTML = '<div class="no-memories">No memories yet! Start chatting with Ducky to create some.</div>';
                } else {
                    memories.forEach(memory => {
                        const memoryDiv = document.createElement('div');
                        memoryDiv.className = 'memory-item';
                        
                        const date = new Date(memory.timestamp * 1000);
                        const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                        
                        memoryDiv.innerHTML = `
                            <div class="memory-header">
                                <span class="memory-date">${formattedDate}</span>
                            </div>
                            <div class="memory-messages">
                                <div class="memory-user-message">
                                    <span class="memory-label">You:</span>
                                    ${escapeHtml(memory.user_message)}
                                </div>
                                <div class="memory-ducky-message">
                                    <span class="memory-label">Ducky:</span>
                                    ${escapeHtml(memory.ducky_response)}
                                </div>
                            </div>
                        `;
                        
                        memoriesList.appendChild(memoryDiv);
                    });
                }
                
                document.getElementById('memoriesModal').classList.add('show');
                toggleMenu(); // Close the slide menu
            } catch (error) {
                console.error('Failed to load memories:', error);
            }
        }

        function hideMemories() {
            document.getElementById('memoriesModal').classList.remove('show');
        }

        function showAccount() {
            document.getElementById('accountModal').classList.add('show');
            document.getElementById('menuOverlay').classList.remove('active');
            document.getElementById('slideMenu').classList.remove('active');
            
            // Populate current username
            document.getElementById('accountUsername').value = currentUser || '';
        }

        function hideAccount() {
            document.getElementById('accountModal').classList.remove('show');
        }

        function handleAvatarChange(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('avatarImage').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        async function updateAccount(event) {
            event.preventDefault();
            
            const username = document.getElementById('accountUsername').value;
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            
            if (newPassword && newPassword !== confirmNewPassword) {
                showError('New passwords do not match');
                return;
            }
            
            try {
                const formData = new FormData();
                const avatarFile = document.getElementById('avatarUpload').files[0];
                if (avatarFile) {
                    formData.append('avatar', avatarFile);
                }
                
                formData.append('username', username);
                if (currentPassword) {
                    formData.append('current_password', currentPassword);
                }
                if (newPassword) {
                    formData.append('new_password', newPassword);
                }
                
                const response = await fetch('/auth/update', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (data.success) {
                    currentUser = username;
                    hideAccount();
                    showError('Account updated successfully');
                } else {
                    showError(data.error);
                }
            } catch (error) {
                console.error('Update account error:', error);
                showError('Failed to update account');
            }
        }
    </script>
</body>
</html> 