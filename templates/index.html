<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#007AFF" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Ducky AI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        .auth-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: calc(100% - 48px); /* Match the form-group width */
            margin: 0 24px; /* Add horizontal margin to match form-group */
            padding: 14px 24px;
            background-color: #007AFF;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .auth-button:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .auth-button .button-text {
            flex: 1;
            text-align: center;
            margin-right: auto;
        }

        .auth-button .button-icon {
            font-size: 20px;
            line-height: 1;
        }

        .dark-mode .auth-button {
            background-color: #0A84FF;
        }

        .dark-mode .auth-button:hover {
            background-color: #0056b3;
        }

        .password-container {
            position: relative;
            flex: 1;
            display: flex;
            align-items: center;
        }

        .password-container input {
            width: 100%;
            padding-right: 40px;
        }

        .password-toggle {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s ease;
        }

        .password-toggle:hover {
            opacity: 0.7;
        }

        .password-toggle .toggle-icon {
            font-size: 16px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .toggle-icon-img {
            width: 16px;
            height: 16px;
            object-fit: contain;
        }
        
        .form-icon {
            width: 18px;
            height: 18px;
            object-fit: contain;
        }
        
        .dark-mode .form-icon,
        .dark-mode .toggle-icon-img {
            filter: invert(0.8);
        }

        .dark-mode .password-toggle {
            color: #999;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
            padding-top: 24px;
        }

        .form-group {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0 24px;
            padding: 12px 16px;
            background-color: #f5f5f5;
            border-radius: 12px;
            transition: background-color 0.3s ease;
        }

        .dark-mode .form-group {
            background-color: #1c1c1e;
        }

        .menu-items {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            width: 100%;
            padding: 16px;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            width: 100%;
            text-align: left;
            padding: 12px 16px;
            gap: 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-radius: 8px;
        }
        
        .menu-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .dark-mode .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .menu-icon-container {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-right: 12px;
        }
        
        .menu-icon {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }
        
        .dark-mode .menu-icon {
            filter: invert(1) brightness(2); /* This will make black icons appear white in dark mode */
        }
        
        .menu-item span {
            font-size: 16px;
        }

        /* Settings Modal Styles */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .settings-modal.show {
            display: flex;
            opacity: 1;
        }
        
        .settings-content {
            background-color: #fff;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            animation: modal-slide-up 0.3s ease;
        }
        
        .dark-mode .settings-content {
            background-color: #1c1c1e;
            color: #fff;
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .dark-mode .settings-header {
            border-bottom-color: #2c2c2e;
        }
        
        .settings-header h2 {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }
        
        .settings-body {
            padding: 20px;
        }
        
        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .settings-form .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .settings-form label {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
            display: block;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 10px;
        }
        
        .slider-container input[type="range"] {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            border-radius: 4px;
            background: linear-gradient(to right, #007AFF 0%, #007AFF 50%, #e0e0e0 50%, #e0e0e0 100%);
            outline: none;
            transition: background 0.3s ease;
        }
        
        .dark-mode .slider-container input[type="range"] {
            background: linear-gradient(to right, #0A84FF 0%, #0A84FF 50%, #2c2c2e 50%, #2c2c2e 100%);
        }
        
        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #ffffff;
            border: 2px solid #007AFF;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }
        
        .slider-container input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        
        .dark-mode .slider-container input[type="range"]::-webkit-slider-thumb {
            background: #2c2c2e;
            border: 2px solid #0A84FF;
        }
        
        .slider-container input[type="range"]::-moz-range-thumb {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #ffffff;
            border: 2px solid #007AFF;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }
        
        .dark-mode .slider-container input[type="range"]::-moz-range-thumb {
            background: #2c2c2e;
            border: 2px solid #0A84FF;
        }
        
        .slider-value {
            min-width: 42px;
            text-align: center;
            font-weight: 600;
            font-size: 15px;
            color: #007AFF;
            background: rgba(0, 122, 255, 0.1);
            padding: 4px 8px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .dark-mode .slider-value {
            color: #0A84FF;
            background: rgba(10, 132, 255, 0.2);
        }
        
        .setting-description {
            font-size: 13px;
            color: #666;
            margin-top: 4px;
        }
        
        .dark-mode .setting-description {
            color: #999;
        }
        
        .settings-select {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            background-color: #f8f8f8;
            font-size: 15px;
            outline: none;
        }
        
        .dark-mode .settings-select {
            background-color: #2c2c2e;
            border-color: #3c3c3e;
            color: #fff;
        }
        
        .settings-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
        }
        
        .settings-actions button {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            border: none;
        }
        
        .cancel-button {
            background-color: #f2f2f7;
            color: #333;
        }
        
        .save-button {
            background-color: #007AFF;
            color: white;
        }
        
        .dark-mode .cancel-button {
            background-color: #2c2c2e;
            color: #fff;
        }
        
        .dark-mode .save-button {
            background-color: #0A84FF;
        }
        
        @keyframes modal-slide-up {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .avatar-edit-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .camera-icon {
            width: 28px;
            height: 28px;
            filter: brightness(0) invert(1); /* Make the icon white */
        }

        /* Splash screen credit styling */
        .splash-credits {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }
        
        .credit-name {
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Auth Overlay -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-container">
            <div class="auth-header">
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Ducky AI Logo" class="auth-logo">
                <h1 class="auth-title">Ducky AI</h1>
                <p class="auth-subtitle">Your friendly AI duck assistant</p>
            </div>
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
                <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
            </div>
            
            <!-- Login Form -->
            <form id="loginForm" class="auth-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <div class="input-icon"><img src="{{ url_for('static', filename='images/user.icon.png') }}" alt="User" class="form-icon"></div>
                    <input type="text" id="loginUsername" placeholder="Username" required>
                </div>
                <div class="form-group">
                    <div class="input-icon"><img src="{{ url_for('static', filename='images/lock.icon.png') }}" alt="Password" class="form-icon"></div>
                    <div class="password-container">
                    <input type="password" id="loginPassword" placeholder="Password" required>
                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('loginPassword', this)">
                            <span class="toggle-icon"><img src="{{ url_for('static', filename='images/eye.icon.png') }}" alt="Show" class="toggle-icon-img"></span>
                        </button>
                </div>
                </div>
                <button type="submit" class="auth-button">
                    <span class="button-text">Login</span>
                    <span class="button-icon">‚Üí</span>
                </button>
            </form>
            
            <!-- Signup Form -->
            <form id="signupForm" class="auth-form" style="display: none;" onsubmit="handleSignup(event)">
                <div class="form-group">
                    <div class="input-icon"><img src="{{ url_for('static', filename='images/user.icon.png') }}" alt="User" class="form-icon"></div>
                    <input type="text" id="signupUsername" placeholder="Choose Username" required>
                </div>
                <div class="form-group">
                    <div class="input-icon"><img src="{{ url_for('static', filename='images/lock.icon.png') }}" alt="Password" class="form-icon"></div>
                    <div class="password-container">
                    <input type="password" id="signupPassword" placeholder="Choose Password" required>
                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('signupPassword', this)">
                            <span class="toggle-icon"><img src="{{ url_for('static', filename='images/eye.icon.png') }}" alt="Show" class="toggle-icon-img"></span>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <div class="input-icon"><img src="{{ url_for('static', filename='images/lock.icon.png') }}" alt="Password" class="form-icon"></div>
                    <div class="password-container">
                    <input type="password" id="confirmPassword" placeholder="Confirm Password" required>
                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('confirmPassword', this)">
                            <span class="toggle-icon"><img src="{{ url_for('static', filename='images/eye.icon.png') }}" alt="Show" class="toggle-icon-img"></span>
                        </button>
                </div>
                </div>
                <button type="submit" class="auth-button">
                    <span class="button-text">Create Account</span>
                    <span class="button-icon">‚Üí</span>
                </button>
            </form>
            
            <div id="authError" class="auth-error"></div>
        </div>
    </div>

    <!-- Splash Screen -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-content">
            <div class="hello-animation">
                <span class="hello-text">Hello</span>
                <span class="hello-cursor"></span>
            </div>
            <div class="splash-logo">
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Ducky AI Logo" class="splash-icon">
                <span class="splash-title">ducky</span>
            </div>
            <div class="splash-credits">
                <span>Created by</span>
                <span class="credit-name">Amaan Dildar</span>
            </div>
        </div>
    </div>

    <!-- Main App Content -->
    <div class="container" style="display: none;" id="mainContent">
        <!-- Slide-out Menu -->
        <div class="slide-menu-overlay" id="menuOverlay"></div>
        <div class="slide-menu" id="slideMenu">
            <div class="menu-items">
            <button class="menu-item" onclick="showMemories()">
                    <div class="menu-icon-container">
                        <img src="{{ url_for('static', filename='images/mem.icon.png') }}" alt="Memories" class="menu-icon">
                    </div>
                Memories
            </button>
            <button class="menu-item" onclick="toggleDarkMode()">
                    <div class="menu-icon-container">
                        <img src="{{ url_for('static', filename='images/theme.icon.png') }}" alt="Theme" class="menu-icon">
                    </div>
                Theme
            </button>
                <button class="menu-item" onclick="showSettings()">
                    <div class="menu-icon-container">
                        <img src="{{ url_for('static', filename='images/settings.icon.png') }}" alt="Settings" class="menu-icon">
                    </div>
                    Settings
                </button>
            <button class="menu-item" onclick="clearChat()">
                    <div class="menu-icon-container">
                        <img src="{{ url_for('static', filename='images/del-chat.icon.png') }}" alt="Clear Chat" class="menu-icon">
                    </div>
                Clear Chat
            </button>
            <button class="menu-item" onclick="shareChat()">
                    <div class="menu-icon-container">
                        <img src="{{ url_for('static', filename='images/share-chat.png') }}" alt="Share" class="menu-icon">
                    </div>
                Share
            </button>
            <button class="menu-item" onclick="toggleSound()">
                    <div class="menu-icon-container">
                        <img src="{{ url_for('static', filename='images/notif.icon.png') }}" alt="Sound" class="menu-icon">
                    </div>
                Sound
            </button>
            <button class="menu-item" onclick="toggleNotifications()">
                    <div class="menu-icon-container">
                        <img src="{{ url_for('static', filename='images/notif.icon.png') }}" alt="Notifications" class="menu-icon">
                    </div>
                Notifications
            </button>
            <button class="menu-item" onclick="logout()">
                    <div class="menu-icon-container">
                        <img src="{{ url_for('static', filename='images/logout.icon.png') }}" alt="Logout" class="menu-icon">
                    </div>
                Logout
            </button>
            </div>
            <div class="menu-account" onclick="showAccount()">
                <div class="account-preview">
                    <img id="menuAvatarImage" src="{{ url_for('static', filename='images/def_avatar.png') }}" alt="Profile Picture" class="account-avatar">
                    <span id="menuUsername" class="account-username">Account</span>
                </div>
            </div>
        </div>

        <div class="chat-header">
            <button class="menu-button" id="menuButton">‚ò∞</button>
            <h1>
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Ducky AI Logo" class="icon">
                <span class="title">Ducky AI</span>
            </h1>
            <div style="width: 40px"></div><!-- Spacer for alignment -->
        </div>
        <div class="chat-container" id="chatContainer">
            <!-- Chat messages will appear here -->
        </div>
        <div class="input-container">
            <div class="input-wrapper">
                <input type="text" id="userInput" placeholder="Message Ducky..." autocomplete="off">
            </div>
            <button id="sendButton" onclick="sendMessage()">
                <img src="{{ url_for('static', filename='images/send.png') }}" alt="Send">
            </button>
        </div>
    </div>

    <!-- Add Memories Modal -->
    <div class="memories-modal" id="memoriesModal">
        <div class="memories-content">
            <div class="memories-header">
                <h2>Your Memories</h2>
                <button class="close-button" onclick="hideMemories()">‚úï</button>
            </div>
            <div class="memories-list" id="memoriesList"></div>
        </div>
    </div>

    <!-- Account Modal -->
    <div class="account-modal" id="accountModal" onclick="if(event.target === this) hideAccount()">
        <div class="account-content">
            <div class="account-header">
                <h2>Account Settings</h2>
                <button class="close-button" onclick="hideAccount()" aria-label="Close">‚úï</button>
            </div>
            <div class="account-body">
                <div class="avatar-section">
                    <div class="avatar-container">
                        <div class="avatar-preview">
                        <img id="avatarImage" src="{{ url_for('static', filename='images/def_avatar.png') }}" alt="Profile Picture">
                            <div class="avatar-overlay">
                                <span class="avatar-edit-icon">
                                    <img src="{{ url_for('static', filename='images/camera.icon.png') }}" alt="Change Picture" class="camera-icon">
                                </span>
                            </div>
                    </div>
                    <input type="file" id="avatarUpload" class="avatar-upload" accept="image/*" onchange="handleAvatarChange(event)" aria-label="Upload profile picture">
                        <button type="button" class="avatar-button" onclick="document.getElementById('avatarUpload').click()">
                        Change Picture
                    </button>
                </div>
                </div>
                <style>
                    .avatar-section {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        margin-bottom: 20px;
                    }
                    
                    .avatar-container {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 10px;
                    }
                    
                    .avatar-preview {
                        width: 120px;
                        height: 120px;
                        border-radius: 50%;
                        overflow: hidden;
                        position: relative;
                        cursor: pointer;
                        border: 3px solid #007AFF;
                        transition: all 0.3s ease;
                    }
                    
                    .avatar-preview:hover {
                        transform: scale(1.05);
                    }
                    
                    .avatar-preview img {
                        width: 100%;
                        height: 100%;
                        object-fit: cover;
                    }
                    
                    .avatar-overlay {
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        opacity: 0;
                        transition: opacity 0.3s ease;
                    }
                    
                    .avatar-preview:hover .avatar-overlay {
                        opacity: 1;
                    }
                    
                    .avatar-edit-icon {
                        font-size: 24px;
                        color: white;
                    }
                    
                    .avatar-upload {
                        display: none;
                    }
                    
                    .avatar-button {
                        background-color: #007AFF;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 12px;
                        font-size: 16px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        width: 200px;
                        text-align: center;
                        font-weight: 500;
                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                    }
                    
                    .avatar-button:hover {
                        background-color: #0056b3;
                        transform: translateY(-1px);
                        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
                    }
                    
                    .dark-mode .avatar-button {
                        background-color: #0A84FF;
                    }
                    
                    .dark-mode .avatar-button:hover {
                        background-color: #0056b3;
                    }
                </style>
                <form class="account-form" onsubmit="updateAccount(event)">
                    <div class="form-group">
                        <label for="accountUsername">Username</label>
                        <input type="text" id="accountUsername" name="username" placeholder="Enter username" required autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label for="currentPassword">Current Password</label>
                        <input type="password" id="currentPassword" name="current_password" placeholder="Enter current password" autocomplete="current-password">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">New Password</label>
                        <input type="password" id="newPassword" name="new_password" placeholder="Enter new password" autocomplete="new-password">
                    </div>
                    <div class="form-group">
                        <label for="confirmNewPassword">Confirm New Password</label>
                        <input type="password" id="confirmNewPassword" name="confirm_password" placeholder="Confirm new password" autocomplete="new-password">
                    </div>
                    <div class="account-actions">
                        <button type="button" class="cancel-button" onclick="hideAccount()">Cancel</button>
                        <button type="submit" class="save-button">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal" onclick="if(event.target === this) hideSettings()">
        <div class="settings-content">
            <div class="settings-header">
                <h2>AI Settings</h2>
                <button class="close-button" onclick="hideSettings()" aria-label="Close">‚úï</button>
            </div>
            <div class="settings-body">
                <form class="settings-form" onsubmit="saveSettings(event)">
                    <div class="form-group">
                        <label for="aiTemperature">Temperature</label>
                        <div class="slider-container">
                            <input type="range" id="aiTemperature" name="temperature" min="0" max="1" step="0.1" value="0.7">
                            <span class="slider-value" id="temperatureValue">0.7</span>
                        </div>
                        <div class="setting-description">
                            Controls randomness: Lower values are more focused and deterministic, higher values are more creative.
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="aiMaxTokens">Max Response Length</label>
                        <div class="slider-container">
                            <input type="range" id="aiMaxTokens" name="maxTokens" min="100" max="1000" step="50" value="500">
                            <span class="slider-value" id="maxTokensValue">500</span>
                        </div>
                        <div class="setting-description">
                            Maximum number of tokens (words) in Ducky's responses.
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="aiPersonality">Ducky's Personality</label>
                        <select id="aiPersonality" name="personality" class="settings-select">
                            <option value="helpful">Helpful & Friendly</option>
                            <option value="formal">Professional & Formal</option>
                            <option value="enthusiastic">Enthusiastic & Playful</option>
                            <option value="concise">Concise & Direct</option>
                        </select>
                        <div class="setting-description">
                            Determines how Ducky will respond to your questions.
                        </div>
                    </div>
                    
                    <div class="settings-actions">
                        <button type="button" class="cancel-button" onclick="hideSettings()">Cancel</button>
                        <button type="submit" class="save-button">Save Settings</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Pre-render URLs for use in JavaScript
        const EYE_ICON_URL = "{{ url_for('static', filename='images/eye.icon.png') }}";
        const EYE_OFF_ICON_URL = "{{ url_for('static', filename='images/eye-off.icon.png') }}";
        
        // Force dark mode on if needed - this should happen before any content is rendered
        const forceDarkMode = window.localStorage.getItem('darkMode') === 'true';
        if (forceDarkMode) {
            document.body.classList.add('dark-mode');
            document.body.classList.add('force-dark');
            console.log("Forcing dark mode: ON");
        } else {
            console.log("No forced dark mode");
        }
    
        // Add image error handling
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.menu-icon').forEach(function(img) {
                img.addEventListener('error', function() {
                    this.src = "{{ url_for('static', filename='images/logo.png') }}";
                });
            });
        });
        
        // Add base URL configuration
        const API_BASE_URL = window.location.hostname === 'localhost' ? '' : 'https://duckyai.onrender.com';
        let currentUser = null;
        let darkMode = false; // Initialize dark mode as false by default
        
        let conversationId = null;
        let pingInterval = null;
        let pingFailCount = 0;
        const MAX_PING_FAILURES = 3;
        const PING_INTERVAL = 120000; // 2 minutes in milliseconds
        
        // Store conversation history for maintaining context
        let conversationMessages = [];
        
        // Add ping functionality
        function startPingInterval() {
            // Clear any existing interval
            if (pingInterval) {
                clearInterval(pingInterval);
            }
            
            // Reset failure count
            pingFailCount = 0;
            
            // Start new ping interval
            pingInterval = setInterval(async () => {
                try {
                    const response = await fetch('/ping');
                    if (!response.ok) {
                        throw new Error('Ping failed');
                    }
                    // Reset failure count on successful ping
                    pingFailCount = 0;
                } catch (error) {
                    console.error('Ping error:', error);
                    pingFailCount++;
                    
                    if (pingFailCount >= MAX_PING_FAILURES) {
                        clearInterval(pingInterval);
                        showError('Lost connection to server. Please refresh the page.');
                    }
                }
            }, PING_INTERVAL);
        }

        // Check authentication status on load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
        });

        function checkAuthStatus() {
            fetch('/auth/status')
                .then(response => response.json())
                .then(data => {
                    if (data.authenticated) {
                        currentUser = data.username;
                        // Update avatar if available, otherwise use default
                        const defaultAvatar = "{{ url_for('static', filename='images/def_avatar.png') }}";
                        const avatarUrl = data.avatar_url ? `${data.avatar_url}?t=${new Date().getTime()}` : defaultAvatar;
                        document.getElementById('avatarImage').src = avatarUrl;
                        document.getElementById('menuAvatarImage').src = avatarUrl;
                        hideAuthOverlay();
                        startApp();
                    } else {
                        showAuthOverlay();
                    }
                })
                .catch(error => {
                    console.error('Auth status error:', error);
                    showAuthOverlay();
                });
        }

        function showAuthOverlay() {
            document.getElementById('authOverlay').style.display = 'flex';
            document.getElementById('splashScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
        }

        function hideAuthOverlay() {
            document.getElementById('authOverlay').style.display = 'none';
        }

        function switchAuthTab(tab) {
            document.getElementById('loginForm').style.display = tab === 'login' ? 'flex' : 'none';
            document.getElementById('signupForm').style.display = tab === 'signup' ? 'flex' : 'none';
            
            // Update active tab
            document.querySelectorAll('.auth-tab').forEach(button => {
                button.classList.toggle('active', button.textContent.toLowerCase() === tab);
            });
            
            // Clear error message
            document.getElementById('authError').textContent = '';
        }

        function showError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch('/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentUser = data.username;
                    hideAuthOverlay();
                    startApp();
                } else {
                    showError(data.error || 'Login failed');
                }
            } catch (error) {
                showError('Network error. Please try again.');
            }
        }

        async function handleSignup(event) {
            event.preventDefault();
            const username = document.getElementById('signupUsername').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (password !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }
            
            try {
                const response = await fetch('/auth/signup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentUser = data.username;
                    hideAuthOverlay();
                    startApp();
                } else {
                    showError(data.error || 'Signup failed');
                }
            } catch (error) {
                showError('Network error. Please try again.');
            }
        }

        async function logout() {
            try {
                await fetch('/auth/logout', { method: 'POST' });
                currentUser = null;
                showAuthOverlay();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        function startApp() {
            // Initialize conversation ID
            conversationId = null;
            
            // Initialize conversation history
            conversationMessages = [];
            
            // Start the ping interval
            startPingInterval();
            
            // Show main content and hide auth overlay
            const authOverlay = document.getElementById('authOverlay');
            const mainContent = document.getElementById('mainContent');
            const splashScreen = document.getElementById('splashScreen');
            
            authOverlay.style.display = 'none';
            splashScreen.style.display = 'flex';
            mainContent.style.display = 'none';
            
            // Show splash screen animation
            setTimeout(function() {
                splashScreen.classList.add('fade-out');
                
                setTimeout(function() {
                    splashScreen.style.display = 'none';
                    mainContent.style.display = 'flex';
                    mainContent.classList.add('fade-in');
                    
                    // Clear chat and add welcome message
                    const chatContainer = document.getElementById('chatContainer');
                    chatContainer.innerHTML = '';
                    
                    const welcomeMessage = [
                        'Hello there!',
                        'I\'m your AI assistant, ready to help with any questions or tasks you might have.',
                        'What would you like to discuss today?'
                    ];
                    
                    addMessageToChat('ducky', welcomeMessage);
                    
                    // Add initial greeting to conversation history
                    conversationMessages.push({
                        user_message: "",
                        ducky_response: welcomeMessage.join(' ')
                    });
                    
                    // Focus input field
                    document.getElementById('userInput').focus();
                }, 800);
            }, 4500);
        }

        // Add message to chat
        function addMessageToChat(type, message) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            // Remove any existing typing indicators for Ducky messages
            if (type === 'ducky') {
                const typingMessages = document.querySelectorAll('.typing-message');
                typingMessages.forEach(msg => msg.remove());
            }
            
            let content = '';
            
            if (type === 'user') {
                // Fetch current avatar URL from the account modal or use default
                const currentAvatar = document.getElementById('avatarImage').src;
                const defaultAvatar = "{{ url_for('static', filename='images/def_avatar.png') }}";
                content = `
                    <div class="text">${Array.isArray(message) ? message.join('<br>') : escapeHtml(message)}</div>
                    <div class="avatar">
                        <img src="${currentAvatar || defaultAvatar}" alt="User Avatar" class="avatar-img" onerror="this.src='${defaultAvatar}'">
                    </div>
                `;
            } else if (type === 'ducky') {
                content = `
                    <div class="avatar">
                        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Ducky AI Logo" class="avatar-img">
                    </div>
                    <div class="text">${Array.isArray(message) ? message.join('<br>') : escapeHtml(message)}</div>
                `;
            } else if (type === 'error') {
                content = `
                    <div class="avatar">‚ö†Ô∏è</div>
                    <div class="text">${Array.isArray(message) ? message.join('<br>') : escapeHtml(message)}</div>
                `;
            }
            
            messageDiv.innerHTML = content;
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        // Scroll to bottom of chat
        function scrollToBottom() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Add loading state to button
        function setButtonLoading(loading) {
            const button = document.getElementById('sendButton');
            
            if (loading) {
                button.disabled = true;
                button.classList.add('loading');
            } else {
                button.disabled = false;
                button.classList.remove('loading');
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Add typing animation to messages
        function addTypingAnimation(text) {
            // Simpler version that ensures text actually appears
            return escapeHtml(text);
        }

        // Create a typing indicator with animated dots
        function createTypingIndicator() {
            return `
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
        }

        // Menu functions
        function clearChat() {
            const chatContainer = document.getElementById('chatContainer');
            // Clear the chat
            chatContainer.innerHTML = '';
            conversationId = null;
            
            // Clear conversation history
            conversationMessages = [];
            
            // Add initial welcome message from Ducky
            setTimeout(() => {
                addMessageToChat('ducky', [
                    'Hello there!',
                    'I\'m your AI assistant, ready to help with any questions or tasks you might have.',
                    'What would you like to discuss today?'
                ]);
            }, 300);
        }

        function toggleDarkMode() {
            console.log("Toggle dark mode called. Current state:", darkMode);
            
            // Toggle dark mode state
            darkMode = !darkMode;
            
            console.log("New dark mode state:", darkMode);
            
            // Force add/remove classes instead of toggle
            if (darkMode) {
                document.body.classList.add('dark-mode');
                document.body.classList.add('force-dark');
                document.body.classList.remove('force-light');
            } else {
                document.body.classList.remove('dark-mode');
                document.body.classList.remove('force-dark');
                document.body.classList.add('force-light');
            }
            
            // Save both preferences for compatibility
            localStorage.setItem('darkMode', darkMode);
            localStorage.setItem('theme', darkMode ? 'dark' : 'light');
            
            console.log("Body has dark-mode class:", document.body.classList.contains('dark-mode'));
            
            // Update splash screen theme
            updateSplashScreenTheme(darkMode);
            
            // Dispatch event for other components to react to dark mode change
            window.dispatchEvent(new CustomEvent('dark-mode-changed', {
                detail: { darkMode: darkMode }
            }));
            
            // Close menu after toggling dark mode
            if (slideMenu.classList.contains('active')) {
                toggleMenu();
            }
            
            // Manual update of the sliders' background gradients
            const temperatureSlider = document.getElementById('aiTemperature');
            const maxTokensSlider = document.getElementById('aiMaxTokens');
            
            if (temperatureSlider) updateSliderBackground(temperatureSlider);
            if (maxTokensSlider) updateSliderBackground(maxTokensSlider);
        }

        // Add helper function for theme icons
        function getThemeIcon(theme) {
            switch (theme) {
                case 'dark': return '‚òÄÔ∏è';
                case 'light': return 'üåë';
                default: return 'üåì';
            }
        }

        async function shareChat() {
            try {
                // Get all message texts
                const messages = Array.from(document.querySelectorAll('.message .text'))
                    .map(el => el.textContent.trim())
                    .join('\n\n');
                
                if (navigator.share) {
                    await navigator.share({
                        title: 'Chat with Ducky AI',
                        text: messages
                    });
                } else {
                    // Fallback for browsers that don't support the Web Share API
                    const textarea = document.createElement('textarea');
                    textarea.value = messages;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    alert('Chat copied to clipboard!');
                }
            } catch (error) {
                console.error('Error sharing:', error);
            }
        }

        // Menu handling
        const menuButton = document.getElementById('menuButton');
        const slideMenu = document.getElementById('slideMenu');
        const menuOverlay = document.getElementById('menuOverlay');

        menuButton.addEventListener('click', toggleMenu);
        menuOverlay.addEventListener('click', toggleMenu);

        function toggleMenu() {
            slideMenu.classList.toggle('active');
            menuOverlay.classList.toggle('active');
            menuButton.textContent = slideMenu.classList.contains('active') ? '‚úï' : '‚ò∞';
        }

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            if (slideMenu.classList.contains('active') &&
                !e.target.closest('.slide-menu') &&
                !e.target.closest('.menu-button')) {
                toggleMenu();
            }
        });

        // New menu functions
        function toggleSound() {
            // Implement sound toggle functionality
            alert('Sound toggle coming soon!');
        }

        function toggleNotifications() {
            // Implement notifications toggle functionality
            alert('Notifications toggle coming soon!');
        }

        // Initialize and handle dark mode
        window.addEventListener('load', function() {
            console.log("Initializing dark mode...");
            
            // Check for saved dark mode preference (use either storage mechanism)
            const savedDarkMode = localStorage.getItem('darkMode');
            const savedTheme = localStorage.getItem('theme');
            
            // Determine initial dark mode state
            if (savedDarkMode !== null) {
                // Use stored preference if available
                darkMode = savedDarkMode === 'true';
                console.log("Using saved darkMode preference:", darkMode);
            } else if (savedTheme !== null) {
                // Fall back to theme preference if available
                darkMode = savedTheme === 'dark';
                console.log("Using saved theme preference:", darkMode);
            } else {
                // Otherwise use system preference
                darkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
                console.log("Using system preference:", darkMode);
                
                // Save preferences
                localStorage.setItem('darkMode', darkMode);
                localStorage.setItem('theme', darkMode ? 'dark' : 'light');
            }
            
            // Apply initial dark mode setting
            if (darkMode) {
                document.body.classList.add('dark-mode');
                document.body.classList.add('force-dark');
                document.body.classList.remove('force-light');
            } else {
                document.body.classList.remove('dark-mode');
                document.body.classList.remove('force-dark');
                document.body.classList.add('force-light');
            }
            
            console.log("Initial dark mode applied, body has dark-mode class:", 
                      document.body.classList.contains('dark-mode'));
            
            // Initialize slider backgrounds
            const temperatureSlider = document.getElementById('aiTemperature');
            const maxTokensSlider = document.getElementById('aiMaxTokens');
            
            if (temperatureSlider) updateSliderBackground(temperatureSlider);
            if (maxTokensSlider) updateSliderBackground(maxTokensSlider);
            
            // Update splash screen theme
            updateSplashScreenTheme(darkMode);
            
            // Listen for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                // Only update if user hasn't set a preference
                if (localStorage.getItem('darkMode') === null && localStorage.getItem('theme') === null) {
                    console.log("System theme changed:", e.matches ? "dark" : "light");
                    darkMode = e.matches;
                    
                    // Apply dark mode
                    if (darkMode) {
                        document.body.classList.add('dark-mode');
                        document.body.classList.add('force-dark');
                        document.body.classList.remove('force-light');
                    } else {
                        document.body.classList.remove('dark-mode');
                        document.body.classList.remove('force-dark');
                        document.body.classList.add('force-light');
                    }
                    
                    // Update UI
                    updateSplashScreenTheme(darkMode);
                    
                    // Update slider backgrounds
                    if (temperatureSlider) updateSliderBackground(temperatureSlider);
                    if (maxTokensSlider) updateSliderBackground(maxTokensSlider);
                }
            });
        });

        // Handle swipe to close menu (update for left side)
        let touchStartX = 0;
        slideMenu.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
        });

        slideMenu.addEventListener('touchmove', (e) => {
            if (!slideMenu.classList.contains('active')) return;
            
            const touchX = e.touches[0].clientX;
            const diff = touchStartX - touchX;
            
            if (diff > 30) {
                toggleMenu();
            }
        });

        // Prevent bounce scrolling on iOS
        document.body.addEventListener('touchmove', (e) => {
            if (e.target.closest('.chat-container')) return;
            e.preventDefault();
        }, { passive: false });

        // Update the message template to use the logo image
        function createMessageElement(text, isDucky = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isDucky ? 'ducky-message' : 'user-message'}`;
            
            // Create avatar
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'avatar';
            
            if (isDucky) {
                const avatarImg = document.createElement('img');
                avatarImg.src = "{{ url_for('static', filename='images/logo.png') }}";
                avatarImg.alt = "Ducky AI Logo";
                avatarImg.className = "avatar-img";
                avatarDiv.appendChild(avatarImg);
            }
            
            // Create text container
            const textDiv = document.createElement('div');
            textDiv.className = 'text';
            
            if (Array.isArray(text)) {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'typing-animation';
                
                text.forEach(line => {
                    const span = document.createElement('span');
                    span.textContent = line;
                    typingDiv.appendChild(span);
                });
                
                textDiv.appendChild(typingDiv);
            } else {
                textDiv.textContent = text;
            }
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(textDiv);
            
            return messageDiv;
        }

        // Enhanced slider interaction with improved dragging
        document.addEventListener('DOMContentLoaded', function() {
            // Define global function for updating slider backgrounds
            window.updateSliderBackground = function(slider) {
                if (!slider) return;
                
                const value = (slider.value - slider.min) / (slider.max - slider.min) * 100;
                const isDarkMode = document.body.classList.contains('dark-mode');
                const activeColor = isDarkMode ? '#0A84FF' : '#007AFF';
                const inactiveColor = isDarkMode ? '#2c2c2e' : '#e0e0e0';
                
                slider.style.background = `linear-gradient(to right, ${activeColor} 0%, ${activeColor} ${value}%, ${inactiveColor} ${value}%, ${inactiveColor} 100%)`;
            };
            
            const temperatureSlider = document.getElementById('aiTemperature');
            const temperatureValue = document.getElementById('temperatureValue');
            const maxTokensSlider = document.getElementById('aiMaxTokens');
            const maxTokensValue = document.getElementById('maxTokensValue');
            
            // Helper function to setup slider behavior
            function setupSlider(slider, valueDisplay) {
                if (!slider || !valueDisplay) return;
                
                // Load saved values from localStorage
                const sliderName = slider.name || slider.id.replace('ai', '').toLowerCase();
                const savedValue = localStorage.getItem(sliderName);
                
                if (savedValue) {
                    slider.value = savedValue;
                    valueDisplay.textContent = savedValue;
                    updateSliderBackground(slider);
                } else {
                    updateSliderBackground(slider); // Initialize with default value
                }
                
                // Core slider input event
                slider.addEventListener('input', function() {
                    valueDisplay.textContent = this.value;
                    updateSliderBackground(this);
                });
                
                // Enhanced mobile support
                slider.addEventListener('touchstart', function(e) {
                    // Prevent default to avoid scroll when dragging
                    e.preventDefault();
                    
                    const handleTouch = function(e) {
                        const touch = e.touches[0];
                        const sliderRect = slider.getBoundingClientRect();
                        const newRatio = Math.max(0, Math.min(1, (touch.clientX - sliderRect.left) / sliderRect.width));
                        
                        // Calculate the new value based on slider's min, max, and step
                        const range = parseFloat(slider.max) - parseFloat(slider.min);
                        let newValue = parseFloat(slider.min) + newRatio * range;
                        
                        // Round to respect the step
                        const step = parseFloat(slider.step) || 1;
                        newValue = Math.round(newValue / step) * step;
                        
                        // Ensure value is within bounds
                        newValue = Math.max(parseFloat(slider.min), Math.min(parseFloat(slider.max), newValue));
                        
                        // Update slider value
                        slider.value = newValue;
                        valueDisplay.textContent = slider.value;
                        updateSliderBackground(slider);
                    };
                    
                    // Handle move events
                    document.addEventListener('touchmove', handleTouch, { passive: false });
                    
                    // Clean up on touch end
                    document.addEventListener('touchend', function cleanup() {
                        document.removeEventListener('touchmove', handleTouch);
                        document.removeEventListener('touchend', cleanup);
                    });
                });
                
                // Enhanced mouse support for more precise dragging
                slider.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    
                    const handleMouseMove = function(e) {
                        const sliderRect = slider.getBoundingClientRect();
                        const newRatio = Math.max(0, Math.min(1, (e.clientX - sliderRect.left) / sliderRect.width));
                        
                        // Calculate the new value based on slider's min, max, and step
                        const range = parseFloat(slider.max) - parseFloat(slider.min);
                        let newValue = parseFloat(slider.min) + newRatio * range;
                        
                        // Round to respect the step
                        const step = parseFloat(slider.step) || 1;
                        newValue = Math.round(newValue / step) * step;
                        
                        // Ensure value is within bounds
                        newValue = Math.max(parseFloat(slider.min), Math.min(parseFloat(slider.max), newValue));
                        
                        // Update slider value
                        slider.value = newValue;
                        valueDisplay.textContent = slider.value;
                        updateSliderBackground(slider);
                    };
                    
                    // Handle move events
                    document.addEventListener('mousemove', handleMouseMove);
                    
                    // Clean up on mouse up
                    document.addEventListener('mouseup', function cleanup() {
                        document.removeEventListener('mousemove', handleMouseMove);
                        document.removeEventListener('mouseup', cleanup);
                    });
                });
            }
            
            // Setup both sliders
            setupSlider(temperatureSlider, temperatureValue);
            setupSlider(maxTokensSlider, maxTokensValue);
            
            // Update backgrounds on dark mode toggle
            window.addEventListener('dark-mode-changed', function() {
                updateSliderBackground(temperatureSlider);
                updateSliderBackground(maxTokensSlider);
            });
        });
        
        // Update the sendMessage function to include AI settings
        function sendMessage() {
            const inputField = document.getElementById('userInput');
            const message = inputField.value.trim();
            
            if (!message) return;
            
            // Check if the user is asking specifically about who created the AI
            const lowerMessage = message.toLowerCase();
            
            // More precise detection of creator questions with word boundaries
            const isCreatorQuestion = (
                /\bwho made you\b/.test(lowerMessage) ||
                /\bwho created you\b/.test(lowerMessage) ||
                /\bwho built you\b/.test(lowerMessage) ||
                /\bwho developed you\b/.test(lowerMessage) ||
                /\bwho is your creator\b/.test(lowerMessage) ||
                /\bwho's your creator\b/.test(lowerMessage) ||
                /\bwho programmed you\b/.test(lowerMessage) ||
                /\bwho is amaan\b/.test(lowerMessage) ||
                /\bwho is amaan dildar\b/.test(lowerMessage) ||
                (lowerMessage.includes("creator") && lowerMessage.includes("who")) ||
                (lowerMessage.includes("made") && lowerMessage.includes("who"))
            );
            
            // Add user message to chat
            addMessageToChat('user', message);
            
            // Store user message in conversation history
            const userMessage = {
                user_message: message,
                ducky_response: '' // This will be filled after we get the response
            };
            
            // Clear input
            inputField.value = '';
            
            // Get AI settings from localStorage
            const temperature = parseFloat(localStorage.getItem('temperature') || '0.7');
            const maxTokens = parseInt(localStorage.getItem('maxTokens') || '500');
            const personality = localStorage.getItem('personality') || 'helpful';
            
            // Debug log
            console.log('Sending message with settings:', { temperature, maxTokens, personality });
            
            // Add typing indicator
            const chatContainer = document.getElementById('chatContainer');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ducky-message typing-message';
            typingDiv.innerHTML = `
                <div class="avatar">
                    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Ducky AI Logo" class="avatar-img">
                </div>
                <div class="text">${createTypingIndicator()}</div>
            `;
            chatContainer.appendChild(typingDiv);
            scrollToBottom();
            
            // Set button to loading state
            setButtonLoading(true);
            
            // Call the API for a response with settings
            fetch('/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    conversation_id: conversationId,
                    conversation_history: conversationMessages, // Send full conversation history
                    settings: {
                        temperature: temperature,
                        max_tokens: maxTokens,
                        personality: personality
                    }
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('API response received:', data);
                
                // Remove typing indicator
                const typingMessages = document.querySelectorAll('.typing-message');
                typingMessages.forEach(msg => msg.remove());
                
                // Add the actual API response
                addMessageToChat('ducky', data.response);
                
                // Complete the user message with the AI's response and add to conversation history
                userMessage.ducky_response = data.response;
                conversationMessages.push(userMessage);
                
                // Limit conversation history to last 10 messages to avoid token limit issues
                if (conversationMessages.length > 10) {
                    conversationMessages = conversationMessages.slice(-10);
                }
                
                // Store conversation ID if provided
                if (data.conversation_id) {
                    conversationId = data.conversation_id;
                }
                
                // Reset button state
                setButtonLoading(false);
            })
            .catch(error => {
                console.error('API error:', error);
                
                // Remove typing indicator
                const typingMessages = document.querySelectorAll('.typing-message');
                typingMessages.forEach(msg => msg.remove());
                
                // Show error message
                addMessageToChat('error', 'Sorry, I\'m having trouble connecting right now. Please try again later.');
                
                // Reset button state
                setButtonLoading(false);
            });
            
            // Focus input field
            inputField.focus();
        }

        // Add enter key support
        document.getElementById('userInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Focus input on page load
        window.addEventListener('load', function() {
            document.getElementById('userInput').focus();
        });

        async function showMemories() {
            try {
                const response = await fetch('/memories');
                const data = await response.json();
                const memories = data.memories;  // Access the memories array from the response object
                
                const memoriesList = document.getElementById('memoriesList');
                memoriesList.innerHTML = '';
                
                if (!memories || memories.length === 0) {
                    memoriesList.innerHTML = '<div class="no-memories">No memories yet! Start chatting with Ducky to create some.</div>';
                } else {
                    memories.forEach(memory => {
                        const memoryDiv = document.createElement('div');
                        memoryDiv.className = 'memory-item';
                        
                        const date = new Date(memory.timestamp);  // Remove * 1000 as timestamp is already ISO format
                        const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                        
                        memoryDiv.innerHTML = `
                            <div class="memory-header">
                                <span class="memory-date">${formattedDate}</span>
                            </div>
                            <div class="memory-messages">
                                <div class="memory-user-message">
                                    <span class="memory-label">You:</span>
                                    ${escapeHtml(memory.user_message)}
                                </div>
                                <div class="memory-ducky-message">
                                    <span class="memory-label">Ducky:</span>
                                    ${escapeHtml(memory.ducky_response)}
                                </div>
                            </div>
                        `;
                        memoriesList.appendChild(memoryDiv);
                    });
                }
                
                document.getElementById('memoriesModal').classList.add('show');
                document.getElementById('menuOverlay').classList.remove('active');
                document.getElementById('slideMenu').classList.remove('active');
            } catch (error) {
                console.error('Failed to load memories:', error);
                showError('Failed to load memories. Please try again.');
            }
        }

        function hideMemories() {
            document.getElementById('memoriesModal').classList.remove('show');
        }

        function showAccount() {
            document.getElementById('accountModal').classList.add('show');
            document.getElementById('menuOverlay').classList.remove('active');
            document.getElementById('slideMenu').classList.remove('active');
            
            // Populate current username
            document.getElementById('accountUsername').value = currentUser || '';
        }

        function hideAccount() {
            document.getElementById('accountModal').classList.remove('show');
        }

        function handleAvatarChange(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Update both the profile and menu avatars
                    document.getElementById('avatarImage').src = e.target.result;
                    document.getElementById('menuAvatarImage').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        async function updateAccount(event) {
            event.preventDefault();
            
            try {
                const username = document.getElementById('accountUsername').value;
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmNewPassword = document.getElementById('confirmNewPassword').value;
                
                if (newPassword && newPassword !== confirmNewPassword) {
                    showError('New passwords do not match');
                    return;
                }
                
                const formData = new FormData();
                const avatarFile = document.getElementById('avatarUpload').files[0];
                if (avatarFile) {
                    formData.append('avatar', avatarFile);
                }
                
                formData.append('username', username);
                if (currentPassword) {
                    formData.append('current_password', currentPassword);
                }
                if (newPassword) {
                    formData.append('new_password', newPassword);
                }
                
                // Construct the full URL for the update endpoint
                const updateUrl = window.location.hostname === 'localhost' ? '/auth/update' : `${API_BASE_URL}/auth/update`;
                
                const response = await fetch(updateUrl, {
                    method: 'POST',
                    body: formData
                });
                
                // Check response status before trying to parse JSON
                if (!response.ok) {
                    // Try to get error details from the response
                    let errorMessage = 'Failed to update account';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorMessage;
                    } catch (parseError) {
                        // If we can't parse JSON, use the status text
                        errorMessage = `${errorMessage}: ${response.status} ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                    currentUser = username;
                    hideAccount();
                    showSuccess('Account updated successfully');
                    
                // Update all user avatars in the chat and menu
                    if (data.avatar_url) {
                    const newAvatarUrl = `${data.avatar_url}?t=${new Date().getTime()}`;
                    // Update menu avatar
                    document.getElementById('menuAvatarImage').src = newAvatarUrl;
                    // Update profile avatar
                    document.getElementById('avatarImage').src = newAvatarUrl;
                    // Update chat avatars
                        const userAvatars = document.querySelectorAll('.user-message .avatar');
                        userAvatars.forEach(avatar => {
                        avatar.innerHTML = `<img src="${newAvatarUrl}" alt="User Avatar" class="avatar-img">`;
                        });
                    }
                    
                    // Update the welcome message with new username
                    const chatContainer = document.getElementById('chatContainer');
                    const firstMessage = chatContainer.querySelector('.ducky-message .text');
                    if (firstMessage) {
                    firstMessage.innerHTML = `Welcome back, ${username}!<br>I'm your AI assistant, ready to help with any questions or tasks you might have.<br>What would you like to discuss today?`;
                }
            } catch (error) {
                console.error('Update account error:', error);
                showError(error.message || 'Failed to update account. Please try again.');
            }
        }

        // Add success message function
        function showSuccess(message) {
            const errorElement = document.getElementById('authError');
            errorElement.style.color = '#10a37f';
            errorElement.textContent = message;
            setTimeout(() => {
                errorElement.textContent = '';
            }, 3000);
        }

        function togglePasswordVisibility(inputId, button) {
            const input = document.getElementById(inputId);
            const icon = button.querySelector('.toggle-icon');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.innerHTML = '<img src="{{ url_for(\'static\', filename=\'images/eye-off.icon.png\') }}" alt="Hide" class="toggle-icon-img">';
            } else {
                input.type = 'password';
                icon.innerHTML = '<img src="{{ url_for(\'static\', filename=\'images/eye.icon.png\') }}" alt="Show" class="toggle-icon-img">';
            }
        }

        function showSettings() {
            document.getElementById('settingsModal').classList.add('show');
            document.getElementById('menuOverlay').classList.remove('active');
            document.getElementById('slideMenu').classList.remove('active');
            
            // Populate settings
            const temperatureSlider = document.getElementById('aiTemperature');
            const maxTokensSlider = document.getElementById('aiMaxTokens');
            const personalitySelect = document.getElementById('aiPersonality');
            
            temperatureSlider.value = localStorage.getItem('temperature') || '0.7';
            maxTokensSlider.value = localStorage.getItem('maxTokens') || '500';
            personalitySelect.value = localStorage.getItem('personality') || 'helpful';
        }

        function hideSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        function saveSettings(event) {
            event.preventDefault();
            
            const temperature = document.getElementById('aiTemperature').value;
            const maxTokens = document.getElementById('aiMaxTokens').value;
            const personality = document.getElementById('aiPersonality').value;
            
            // Save to localStorage
            localStorage.setItem('temperature', temperature);
            localStorage.setItem('maxTokens', maxTokens);
            localStorage.setItem('personality', personality);
            
            // Update any visual elements
            const temperatureValue = document.getElementById('temperatureValue');
            const maxTokensValue = document.getElementById('maxTokensValue');
            
            if (temperatureValue) temperatureValue.textContent = temperature;
            if (maxTokensValue) maxTokensValue.textContent = maxTokens;
            
            // Update slider backgrounds
            const temperatureSlider = document.getElementById('aiTemperature');
            const maxTokensSlider = document.getElementById('aiMaxTokens');
            
            if (temperatureSlider) updateSliderBackground(temperatureSlider);
            if (maxTokensSlider) updateSliderBackground(maxTokensSlider);
            
            // Hide modal and show success message
            hideSettings();
            showSuccess('Settings saved successfully');
            
            // Optional: If we're in a conversation, we could notify the user that
            // these settings will apply to their next message
        }

        // Function to update splash screen theme
        function updateSplashScreenTheme(isDarkMode) {
            const root = document.documentElement;
            if (isDarkMode) {
                root.style.setProperty('--splash-background', '#1d1d1f');
                root.style.setProperty('--splash-text', '#ffffff');
                root.style.setProperty('--splash-text-rgb', '255, 255, 255');
            } else {
                root.style.setProperty('--splash-background', '#ffffff');
                root.style.setProperty('--splash-text', '#000000');
                root.style.setProperty('--splash-text-rgb', '0, 0, 0');
            }
        }
    </script>
</body>
</html> 