<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="theme-color" content="#007AFF" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Ducky AI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Splash Screen -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-content">
            <div class="hello-animation">
                <span>H</span>
                <span>e</span>
                <span>l</span>
                <span>l</span>
                <span>o</span>
            </div>
            <div class="splash-logo">
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Ducky AI Logo" class="splash-icon">
                <span class="splash-title">ducky</span>
            </div>
            <div class="splash-credits">
                <span>Created by</span>
                <span class="credit-name">Amaan Dildar</span>
            </div>
        </div>
    </div>

    <!-- Main App Content -->
    <div class="container" style="display: none;" id="mainContent">
        <!-- Slide-out Menu -->
        <div class="slide-menu-overlay" id="menuOverlay"></div>
        <div class="slide-menu" id="slideMenu">
            <button class="menu-item" onclick="clearChat()">
                <span>üóëÔ∏è</span>
                Clear Chat
            </button>
            <button class="menu-item" onclick="toggleDarkMode()">
                <span>üåì</span>
                Theme
            </button>
            <button class="menu-item" onclick="shareChat()">
                <span>üì§</span>
                Share
            </button>
            <button class="menu-item" onclick="toggleSound()">
                <span>üîä</span>
                Sound
            </button>
            <button class="menu-item" onclick="toggleNotifications()">
                <span>üîî</span>
                Notifications
            </button>
        </div>

        <div class="chat-header">
            <button class="menu-button" id="menuButton">‚ò∞</button>
            <h1>
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Ducky AI Logo" class="icon">
                <span class="title">Ducky AI</span>
            </h1>
            <div style="width: 40px"></div><!-- Spacer for alignment -->
        </div>
        <div class="chat-container" id="chatContainer">
            <div class="pull-indicator">
                <span>Pull to refresh</span>
            </div>
            <div class="message ducky-message">
                <div class="avatar">
                    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Ducky AI Logo" class="avatar-img">
                </div>
                <div class="text">
                    <div class="typing-animation">
                        <span>Quack! Hello there!</span>
                        <span>I'm your friendly AI duck assistant.</span>
                        <span>How can I help you today? ü¶Ü</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="input-container">
            <div class="input-wrapper">
                <input type="text" id="userInput" placeholder="Message Ducky..." autocomplete="off">
            </div>
            <button id="sendButton" onclick="sendMessage()">
                <span class="button-text">Send</span>
            </button>
        </div>
    </div>

    <script>
        let conversationId = null;
        
        // Add initial welcome message when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize conversation ID
            conversationId = null;
            
            // Don't add message here - will be handled after splash screen
        });
        
        // Splash screen handling
        window.addEventListener('load', function() {
            const splashScreen = document.getElementById('splashScreen');
            const mainContent = document.getElementById('mainContent');
            
            // Force splash screen to be visible initially
            splashScreen.style.display = 'flex';
            mainContent.style.display = 'none';
            
            // Show splash screen for 4 seconds
            setTimeout(() => {
                splashScreen.classList.add('fade-out');
                
                // Ensure main content shows up after splash screen fades out
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                    mainContent.style.display = 'flex';
                    mainContent.classList.add('fade-in');
                    
                    // Add initial welcome message from Ducky
                    setTimeout(() => {
                        const chatContainer = document.getElementById('chatContainer');
                        // Clear existing elements except for pull indicator
                        const pullIndicator = chatContainer.querySelector('.pull-indicator');
                        chatContainer.innerHTML = '';
                        if (pullIndicator) chatContainer.appendChild(pullIndicator);
                        
                        // Add the welcome message
                        addMessageToChat('ducky', 'Hi there! I\'m Ducky, your friendly AI assistant. How can I help you today?');
                        document.getElementById('userInput').focus();
                    }, 300);
                }, 500);
            }, 4000);
        });

        // Add message to chat
        function addMessageToChat(type, message) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            // Remove any existing typing indicators for Ducky messages
            if (type === 'ducky') {
                const typingMessages = document.querySelectorAll('.typing-message');
                typingMessages.forEach(msg => msg.remove());
            }
            
            let content = '';
            
            if (type === 'user') {
                content = `
                    <div class="avatar">
                        <span class="user-icon">üë§</span>
                    </div>
                    <div class="text">${escapeHtml(message)}</div>
                `;
            } else if (type === 'ducky') {
                content = `
                    <div class="avatar">
                        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Ducky AI Logo" class="avatar-img">
                    </div>
                    <div class="text">${addTypingAnimation(message)}</div>
                `;
            } else if (type === 'error') {
                content = `
                    <div class="avatar">‚ö†Ô∏è</div>
                    <div class="text">${escapeHtml(message)}</div>
                `;
            }
            
            messageDiv.innerHTML = content;
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        // Scroll to bottom of chat
        function scrollToBottom() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Add loading state to button
        function setButtonLoading(loading) {
            const button = document.getElementById('sendButton');
            const buttonText = button.querySelector('.button-text');
            
            if (loading) {
                button.disabled = true;
                buttonText.textContent = '...';
                button.classList.add('loading');
            } else {
                button.disabled = false;
                buttonText.textContent = 'Send';
                button.classList.remove('loading');
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Add typing animation to messages
        function addTypingAnimation(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const formattedLines = lines.map(line => `<span>${escapeHtml(line)}</span>`).join('');
            return `<div class="typing-animation">${formattedLines}</div>`;
        }

        // Create a typing indicator with animated dots
        function createTypingIndicator() {
            return `
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
        }

        function sendMessage() {
            const inputField = document.getElementById('userInput');
            const message = inputField.value.trim();
            
            if (!message) return;
            
            // Debug log
            console.log('Sending message:', message);
            
            // Add user message to chat
            addMessageToChat('user', message);
            
            // Clear input
            inputField.value = '';
            
            // Add typing indicator
            const chatContainer = document.getElementById('chatContainer');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ducky-message typing-message';
            typingDiv.innerHTML = `
                <div class="avatar">
                    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Ducky AI Logo" class="avatar-img">
                </div>
                <div class="text">${createTypingIndicator()}</div>
            `;
            chatContainer.appendChild(typingDiv);
            scrollToBottom();
            
            // Set button to loading state
            setButtonLoading(true);
            
            // Debug log - request payload
            console.log('Request payload:', {
                message: message,
                conversation_id: conversationId
            });
            
            // Track API failure for fallback 
            let isFallback = false;
            
            // Send message to server
            fetch('/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    conversation_id: conversationId
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                // Debug log
                console.log('Response data:', data);
                
                // Remove typing indicator
                const typingMessages = document.querySelectorAll('.typing-message');
                typingMessages.forEach(msg => msg.remove());
                
                if (data.error) {
                    addMessageToChat('error', data.error);
                } else {
                    // Update conversation ID
                    if (data.conversation_id) {
                        conversationId = data.conversation_id;
                    }
                    
                    // Add response to chat
                    addMessageToChat('ducky', data.response);
                }
                
                // Reset button
                setButtonLoading(false);
            })
            .catch(error => {
                // Debug log
                console.error('Fetch error:', error);
                isFallback = true;
                
                // Use fallback mechanism
                setTimeout(() => {
                    // Remove typing indicator
                    const typingMessages = document.querySelectorAll('.typing-message');
                    typingMessages.forEach(msg => msg.remove());
                    
                    // Generate a fallback response
                    const fallbackResponse = getFallbackResponse(message);
                    addMessageToChat('ducky', fallbackResponse);
                    
                    // Reset button
                    setButtonLoading(false);
                }, 1500);
            });
            
            // Focus input field
            inputField.focus();
        }
        
        // Fallback response generator
        function getFallbackResponse(message) {
            // Simple fallback responses when API is unavailable
            const fallbackResponses = [
                "I'm here to help! What would you like to talk about?",
                "Quack! That's an interesting question. I wish I could give you a more detailed answer right now.",
                "I understand. Tell me more about what you're thinking!",
                "Thanks for sharing. Is there anything specific you'd like to discuss?",
                "I'm processing that. Could you provide a bit more detail?",
                "That's a great point! I'd love to explore that further.",
                "I see what you mean. Let's discuss this more!",
                "Quack! Thanks for chatting with me today.",
                "I'm here to listen and help. What's on your mind?",
                "That's fascinating! I'd like to hear more about your perspective."
            ];
            
            // Check for greetings
            if (message.toLowerCase().match(/^(hi|hello|hey|greetings|howdy)/)) {
                return "Hello there! Nice to meet you. I'm Ducky, your friendly AI assistant. How can I help you today?";
            }
            
            // Check for thanks
            if (message.toLowerCase().match(/(thank|thanks|appreciate|grateful)/)) {
                return "You're very welcome! I'm happy to help anytime. Is there anything else you'd like to talk about?";
            }
            
            // Check for how are you
            if (message.toLowerCase().match(/(how are you|how're you|how's it going|how are things)/)) {
                return "I'm doing great, thanks for asking! I'm always ready to chat and help. How are you doing today?";
            }
            
            // Random response for other messages
            const randomIndex = Math.floor(Math.random() * fallbackResponses.length);
            return fallbackResponses[randomIndex];
        }

        // Add enter key support
        document.getElementById('userInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Focus input on page load
        window.addEventListener('load', function() {
            document.getElementById('userInput').focus();
        });

        // Mobile-specific features
        let startY = 0;
        let pulling = false;

        // Handle pull-to-refresh
        document.getElementById('chatContainer').addEventListener('touchstart', (e) => {
            if (chatContainer.scrollTop === 0) {
                startY = e.touches[0].pageY;
                pulling = true;
            }
        });

        document.getElementById('chatContainer').addEventListener('touchmove', (e) => {
            if (pulling && chatContainer.scrollTop === 0) {
                const pull = e.touches[0].pageY - startY;
                if (pull > 0) {
                    chatContainer.classList.add('pulling');
                    e.preventDefault();
                }
            }
        });

        document.getElementById('chatContainer').addEventListener('touchend', () => {
            if (pulling) {
                chatContainer.classList.remove('pulling');
                pulling = false;
                // Implement refresh logic here
            }
        });

        // Mobile actions
        function clearChat() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '';
            conversationId = null;
            
            // Add initial welcome message from Ducky
            setTimeout(() => {
                addMessageToChat('ducky', 'Hi there! I\'m Ducky, your friendly AI assistant. How can I help you today?');
            }, 300);
        }

        function toggleDarkMode() {
            const body = document.body;
            const currentTheme = localStorage.getItem('theme') || 'system';
            
            let newTheme;
            if (currentTheme === 'system') {
                newTheme = 'dark';
                body.classList.add('force-dark');
                body.classList.remove('force-light');
            } else if (currentTheme === 'dark') {
                newTheme = 'light';
                body.classList.add('force-light');
                body.classList.remove('force-dark');
            } else {
                newTheme = 'system';
                body.classList.remove('force-light');
                body.classList.remove('force-dark');
            }
            
            localStorage.setItem('theme', newTheme);
            
            // Update the theme button text
            const themeButton = document.querySelector('.action-button[onclick="toggleDarkMode()"]');
            const themeIcon = themeButton.querySelector('span');
            themeIcon.textContent = getThemeIcon(newTheme);
        }

        // Add this helper function for theme icons
        function getThemeIcon(theme) {
            switch (theme) {
                case 'dark': return '‚òÄÔ∏è';
                case 'light': return 'üåë';
                default: return 'üåì';
            }
        }

        async function shareChat() {
            try {
                // Get all message texts
                const messages = Array.from(document.querySelectorAll('.message .text'))
                    .map(el => el.textContent.trim())
                    .join('\n\n');
                
                if (navigator.share) {
                    await navigator.share({
                        title: 'Chat with Ducky AI',
                        text: messages
                    });
                } else {
                    // Fallback for browsers that don't support the Web Share API
                    const textarea = document.createElement('textarea');
                    textarea.value = messages;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    alert('Chat copied to clipboard!');
                }
            } catch (error) {
                console.error('Error sharing:', error);
            }
        }

        // Show/hide mobile actions on scroll
        let lastScrollTop = 0;
        document.getElementById('chatContainer').addEventListener('scroll', () => {
            const currentScroll = chatContainer.scrollTop;
            const mobileActions = document.getElementById('mobileActions');
            
            if (currentScroll > lastScrollTop) {
                // Scrolling down
                mobileActions.classList.remove('active');
            } else {
                // Scrolling up
                mobileActions.classList.add('active');
            }
            lastScrollTop = currentScroll;
        });

        // Add double-tap to like animation
        let lastTap = 0;
        document.getElementById('chatContainer').addEventListener('touchend', (e) => {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            
            if (tapLength < 300 && tapLength > 0) {
                const message = e.target.closest('.message');
                if (message) {
                    const heart = document.createElement('div');
                    heart.className = 'heart-animation';
                    heart.innerHTML = '‚ù§Ô∏è';
                    message.appendChild(heart);
                    
                    setTimeout(() => {
                        message.removeChild(heart);
                    }, 1000);
                }
            }
            lastTap = currentTime;
        });

        // Menu handling
        const menuButton = document.getElementById('menuButton');
        const slideMenu = document.getElementById('slideMenu');
        const menuOverlay = document.getElementById('menuOverlay');

        menuButton.addEventListener('click', toggleMenu);
        menuOverlay.addEventListener('click', toggleMenu);

        function toggleMenu() {
            slideMenu.classList.toggle('active');
            menuOverlay.classList.toggle('active');
            menuButton.textContent = slideMenu.classList.contains('active') ? '‚úï' : '‚ò∞';
        }

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            if (slideMenu.classList.contains('active') &&
                !e.target.closest('.slide-menu') &&
                !e.target.closest('.menu-button')) {
                toggleMenu();
            }
        });

        // New menu functions
        function toggleSound() {
            // Implement sound toggle functionality
            alert('Sound toggle coming soon!');
        }

        function toggleNotifications() {
            // Implement notifications toggle functionality
            alert('Notifications toggle coming soon!');
        }

        // Update theme initialization to work with new menu
        window.addEventListener('load', function() {
            const savedTheme = localStorage.getItem('theme') || 'system';
            const body = document.body;
            
            if (savedTheme === 'dark') {
                body.classList.add('force-dark');
                body.classList.remove('force-light');
            } else if (savedTheme === 'light') {
                body.classList.add('force-light');
                body.classList.remove('force-dark');
            }
            
            // Update all theme button icons
            const themeButtons = document.querySelectorAll('[onclick="toggleDarkMode()"]');
            themeButtons.forEach(button => {
                const themeIcon = button.querySelector('span');
                if (themeIcon) {
                    themeIcon.textContent = getThemeIcon(savedTheme);
                }
            });
        });

        // Handle swipe to close menu (update for left side)
        let touchStartX = 0;
        slideMenu.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
        });

        slideMenu.addEventListener('touchmove', (e) => {
            if (!slideMenu.classList.contains('active')) return;
            
            const touchX = e.touches[0].clientX;
            const diff = touchStartX - touchX;
            
            if (diff > 30) {
                toggleMenu();
            }
        });

        // Prevent bounce scrolling on iOS
        document.body.addEventListener('touchmove', (e) => {
            if (e.target.closest('.chat-container')) return;
            e.preventDefault();
        }, { passive: false });

        // Update the message template to use the logo image
        function createMessageElement(text, isDucky = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isDucky ? 'ducky-message' : 'user-message'}`;
            
            // Create avatar
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'avatar';
            
            if (isDucky) {
                const avatarImg = document.createElement('img');
                avatarImg.src = "{{ url_for('static', filename='images/logo.png') }}";
                avatarImg.alt = "Ducky AI Logo";
                avatarImg.className = "avatar-img";
                avatarDiv.appendChild(avatarImg);
            }
            
            // Create text container
            const textDiv = document.createElement('div');
            textDiv.className = 'text';
            
            if (Array.isArray(text)) {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'typing-animation';
                
                text.forEach(line => {
                    const span = document.createElement('span');
                    span.textContent = line;
                    typingDiv.appendChild(span);
                });
                
                textDiv.appendChild(typingDiv);
            } else {
                textDiv.textContent = text;
            }
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(textDiv);
            
            return messageDiv;
        }
    </script>
</body>
</html> 